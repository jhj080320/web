<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EEG 감정 분류 (Teachable Machine)</title>

  <style>
    :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --accent:#22d3ee; --muted:#94a3b8; }
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    .wrap{max-width:900px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;
      padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:clamp(20px,3.2vw,28px);margin:0 0 12px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .pane{flex:1 1 320px}
    .thumb{width:100%;aspect-ratio:16/9;object-fit:contain;
      background:#0b1220;border:1px dashed #334155;border-radius:12px}
    .btn{display:inline-block;background:var(--accent);color:#082f49;
      border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:14px}
    .topline{font-size:20px;font-weight:800;margin:8px 0 12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;text-align:left;border-bottom:1px solid #1f2937}
    .bar{height:10px;background:#0b1220;border-radius:6px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#22d3ee,#38bdf8)}
    .footer{margin-top:14px;font-size:13px;color:#64748b}
    .labelpill{display:inline-block;padding:6px 10px;border-radius:999px;
      background:#0b1220;border:1px solid #1f2937;margin-top:4px}
  </style>

  <!-- Teachable Machine Image 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>EEG 감정 분류 (기쁨 · 슬픔 · 화남 · 편안함)</h1>

      <div class="row">
        <div class="pane">
          <p class="muted">모델 폴더 위치는 <code>./model/</code> (model.json, metadata.json, weights.bin)</p>
          <input id="file" type="file" accept="image/*" />
          <button id="predictBtn" class="btn" disabled>예측 실행</button>
          <div style="margin-top:14px">
            <img id="preview" class="thumb" alt="업로드 미리보기" />
          </div>
          <div class="footer">TIP: FFT 그래프 부분만 자르면 정확도가 올라갑니다.</div>
        </div>

        <div class="pane">
          <div class="topline">최고 확률 감정: <span id="topLabel" class="labelpill">-</span></div>
          <table id="table">
            <thead>
              <tr><th>감정</th><th>확률</th><th style="width:45%">시각화</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="footer" id="meta">모델 로드 중...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const MODEL_URL = "./model/";  // 모델 폴더 경로

    let model, maxPredictions;
    const fileInput = document.getElementById("file");
    const preview = document.getElementById("preview");
    const predictBtn = document.getElementById("predictBtn");
    const tableBody = document.querySelector("#table tbody");
    const topLabel = document.getElementById("topLabel");
    const meta = document.getElementById("meta");

    // 모델 불러오기
    async function loadModel() {
      try {
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        maxPredictions = model.getTotalClasses();
        meta.textContent = `모델 로드 완료 | 클래스 수: ${maxPredictions}`;
        predictBtn.disabled = false;
      } catch (e) {
        meta.textContent = "❌ 모델 로드 실패: ./model/ 폴더 위치와 파일명을 확인하세요.";
        console.error(e);
      }
    }

    // 이미지 선택
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
    });

    // 예측 버튼 클릭
    predictBtn.addEventListener("click", runPredict);

    // 예측 실행
    async function runPredict() {
      if (!model) return alert("모델이 아직 로드되지 않았습니다.");
      if (!preview.src) return alert("이미지를 먼저 업로드하세요.");

      const predictions = await model.predict(preview, false);
      predictions.sort((a, b) => b.probability - a.probability);

      const best = predictions[0];
      topLabel.textContent = `${best.className} (${(best.probability * 100).toFixed(1)}%)`;

      tableBody.innerHTML = "";
      predictions.forEach(p => {
        const prob = (p.probability * 100).toFixed(1);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.className}</td>
          <td>${prob}%</td>
          <td><div class="bar"><span style="width:${prob}%;"></span></div></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // 페이지 로드 시 모델 자동 불러오기
    loadModel();
  </script>
</body>
</html>
