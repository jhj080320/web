<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>뇌파 측정</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    :root { 
      --bg: linear-gradient(180deg, #0c1224, #1b253d); 
      --card: #141b2f; 
      --ink: #f3f4f6; 
      --accent: #2dd4bf; 
      --muted: #9ca3af; 
    }
    body {
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
    }
    .wrap{max-width:900px;margin:40px auto;padding:0 16px}
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:16px;
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    h1{
      font-size:clamp(20px,3.2vw,28px);
      margin:0 0 12px;
      background:linear-gradient(90deg,#5eead4,#60a5fa);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .pane{flex:1 1 320px}
    .thumb{
      width:100%;
      aspect-ratio:16/9;
      object-fit:contain;
      background:#0b1220;
      border:1px dashed #334155;
      border-radius:12px;
      box-shadow:inset 0 0 10px rgba(255,255,255,0.05)
    }
    .btn{
      display:inline-block;
      background:var(--accent);
      color:#083344;
      border:0;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 0 10px rgba(45,212,191,0.4);
      transition:all .2s ease;
    }
    .btn:hover{box-shadow:0 0 14px rgba(45,212,191,0.8); transform:translateY(-1px);}
    .btn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none;}
    .muted{color:var(--muted);font-size:14px}
    .topline{font-size:20px;font-weight:800;margin:8px 0 12px;color:#a5f3fc}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.08)}
    .bar{height:10px;background:#0b1220;border-radius:6px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#2dd4bf,#60a5fa)}
    .footer{margin-top:14px;font-size:13px;color:#93c5fd}
    .labelpill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:#0b1220;
      border:1px solid rgba(255,255,255,0.1);
      color:#a5f3fc;
      font-weight:600;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>EEG 뇌파 분류</h1>

      <div class="row">
        <div class="pane">
          <input id="file" type="file" accept="image/*" />
          <button id="predictBtn" class="btn" disabled>예측 하기</button>
          <div style="margin-top:14px">
            <img id="preview" class="thumb" alt="업로드 미리보기" />
          </div>
          <div class="footer"></div>
        </div>

        <div class="pane">
          <div class="topline">예상되는 감정: <span id="topLabel" class="labelpill">-</span></div>
          <table id="table">
            <thead>
              <tr><th>감정</th><th>확률</th><th style="width:45%"></th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="footer" id="meta">모델 로드 중...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const MODEL_URL = "./model/";
    let model, maxPredictions;
    const fileInput = document.getElementById("file");
    const preview = document.getElementById("preview");
    const predictBtn = document.getElementById("predictBtn");
    const tableBody = document.querySelector("#table tbody");
    const topLabel = document.getElementById("topLabel");
    const meta = document.getElementById("meta");

    async function loadModel() {
      try {
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        maxPredictions = model.getTotalClasses();
        meta.textContent = `AI가 감정을 예측한 결과를 보여줍니다.`;
        predictBtn.disabled = false;
        console.log("모델을 성공적으로 불러왔습니다.", MODEL_URL);
      } catch (e) {
        meta.textContent = "모델 불러오기 실패";
        console.error("모델 불러오기 실패:", e);
      }
    }

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
    });

    predictBtn.addEventListener("click", runPredict);

    async function runPredict() {
      if (!model) return alert("모델이 아직 로드되지 않았습니다.");
      if (!preview.src) return alert("이미지를 먼저 업로드하세요.");

      const predictions = await model.predict(preview, false);
      predictions.sort((a, b) => b.probability - a.probability);

      const best = predictions[0];
      topLabel.textContent = `${best.className} (${(best.probability * 100).toFixed(1)}%)`;

      tableBody.innerHTML = "";
      predictions.forEach(p => {
        const prob = (p.probability * 100).toFixed(1);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.className}</td>
          <td>${prob}%</td>
          <td><div class="bar"><span style="width:${prob}%;"></span></div></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    loadModel();
  </script>
</body>
</html>
