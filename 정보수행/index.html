<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2214 심영제, 2219 장현준</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    :root{
      --bg-1:#0b1220;
      --bg-2:#0e1628;
      --card:rgba(16,22,38,.55);
      --card-border:rgba(255,255,255,.06);
      --ink:#e6ebf3;
      --muted:#9db0c6;
      --accent:#47d6ff;
      --accent-2:#7cf9d8;
      --glow:0 10px 40px rgba(71,214,255,.25);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font-family: 'Inter','Noto Sans KR',ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo;
      background:
        radial-gradient(60% 80% at 10% 10%, #10243d 0%, transparent 60%),
        radial-gradient(70% 90% at 90% 20%, #0e3a36 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
      background-attachment: fixed;
    }

    .wrap{max-width:1100px;margin:48px auto;padding:0 18px}
    h1{font-size:32px;letter-spacing:.3px;margin:0 0 20px;
      font-weight:800;background:linear-gradient(90deg,var(--ink),#cfe9ff);
      -webkit-background-clip:text;background-clip:text;color:transparent}

    .card{
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:var(--radius);
      padding:22px;
      box-shadow: var(--glow);
      backdrop-filter: blur(10px);
    }

    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}

    button, label[for="file"]{
      position:relative;
      background:linear-gradient(180deg, #1b2a44 0%, #162338 100%);
      color:var(--ink);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:10px 16px;
      cursor:pointer;
      transition:.18s transform ease,.18s box-shadow ease,.18s background ease;
      box-shadow:0 4px 14px rgba(0,0,0,.25);
    }
    button:hover{transform:translateY(-1px); box-shadow:0 8px 22px rgba(0,0,0,.35);}
    button:active{transform:translateY(0)}
    button:disabled{opacity:.55;cursor:not-allowed;filter:grayscale(.2)}
    #btnWebcam{background:linear-gradient(90deg, #1f2d4a 0%, #1d3a57 100%);}
    #btnUpload{background:linear-gradient(90deg, #1a3a33 0%, #1b4a41 100%);}
    #btnReset{background:linear-gradient(90deg, #3a1f2f 0%, #51243a 100%);}

    .status{
      font-size:14px;color:var(--muted);margin-left:auto;
      display:flex;align-items:center;gap:8px;white-space:nowrap
    }
    .status::before{
      content:"";
      width:8px;height:8px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, var(--accent), #0ff3);
      box-shadow:0 0 14px var(--accent);
      display:inline-block;
      animation:pulse 1.6s ease-in-out infinite;
    }
    .warn{color:#f7a8a8}
    @keyframes pulse{
      0%,100%{opacity:.7;transform:scale(.95)}
      50%{opacity:1;transform:scale(1)}
    }

    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1;min-width:300px}
    video,canvas,img{
      width:100%;border-radius:14px;background:#0b1220;
      border:1px solid rgba(255,255,255,.06); box-shadow:0 6px 18px rgba(0,0,0,.35)
    }

    .label{font-size:18px;font-weight:700;margin-bottom:6px}
    .prob-row{display:flex;justify-content:space-between;gap:12px;font-size:14px;color:var(--muted)}
    .bar{height:12px;background:linear-gradient(180deg,#0f1a2b,#0e1726);
      border-radius:999px;overflow:hidden;margin:6px 0 16px;border:1px solid rgba(255,255,255,.06)}
    .bar>div{
      height:100%;
      background:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
      width:0%; transition:width .28s ease;
      box-shadow:0 0 16px rgba(71,214,255,.35) inset;
    }

    #dropZone{
      border:2px dashed rgba(135,180,220,.45);
      border-radius:14px;
      padding:46px 20px;
      text-align:center;
      color:var(--muted);
      transition:.18s border-color ease,.18s background ease,.18s color ease,.18s transform ease;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.015));
      backdrop-filter: blur(4px);
      user-select:none;
    }
    #dropZone b{color:#d8e7ff}
    #dropZone.dragover{
      border-color: var(--accent);
      background:linear-gradient(180deg, rgba(71,214,255,.08), rgba(124,249,216,.05));
      color:#dff7ff; transform:scale(1.01);
      box-shadow:0 8px 28px rgba(71,214,255,.15);
    }

    .hidden{display:none!important}

    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#2a3b5c,#1e2b44);border-radius:10px}
    ::-webkit-scrollbar-track{background:rgba(255,255,255,.03)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>표정 인식 인공지능 모델</h1>

    <div class="card">
      <div class="controls">
        <button id="btnWebcam" disabled>웹캠 열기</button>
        <button id="btnUpload" disabled>파일 업로드 하기</button>
        <button id="btnReset" class="hidden">초기화</button>
        <input id="fileInput" type="file" accept="image/*" class="hidden">
        <span class="status" id="status">모델 로드 대기중…</span>
      </div>

      <div class="row">
        <div class="col">
          <video id="webcam" playsinline autoplay muted class="hidden"></video>
          <canvas id="canvas" class="hidden"></canvas>
          <div id="dropZone" class="hidden">
            파일을 <b>여기로 끌어오거나</b><br>아래 버튼을 눌러 업로드하세요.
          </div>
          <img id="preview" alt="preview" class="hidden"/>
        </div>

        <div class="col right-box">
          <div class="label" id="topLabel"></div>
          <div id="probs"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const MODEL_URL = "./model/";
  const SMOOTH_N = 5;
  const FRAME_SIZE = 320;

  let model = null;
  let classNames = [];
  let webcam = null;
  let rafId = null;
  let smoothQueue = [];

  const el = (id)=>document.getElementById(id);
  const statusEl = el("status"), probsEl = el("probs"), topLabelEl = el("topLabel");
  const webcamEl = el("webcam"), canvasEl = el("canvas"), previewEl = el("preview");
  const btnWebcam = el("btnWebcam"), btnUpload = el("btnUpload"), btnReset = el("btnReset");
  const fileInput = el("fileInput"), dropZone = el("dropZone");

  function setStatus(msg, warn=false){
    statusEl.textContent = msg;
    statusEl.className = "status" + (warn ? " warn" : "");
  }
  function hideAllInputs(){
    [webcamEl, canvasEl, previewEl, dropZone].forEach(v => v.classList.add("hidden"));
    stopWebcamLoop();
  }
  function renderProbs(vec){
    const arr = classNames.map((name,i)=>({className:name, probability:vec[i]}))
                          .sort((a,b)=>b.probability - a.probability);
    probsEl.innerHTML = "";
    arr.forEach(p=>{
      const row = document.createElement("div");
      row.className = "prob-row";
      row.innerHTML = `<span>${p.className}</span><span>${(p.probability*100).toFixed(1)}%</span>`;
      const bar = document.createElement("div");
      bar.className = "bar";
      const fill = document.createElement("div");
      fill.style.width = `${p.probability*100}%`;
      bar.appendChild(fill);
      probsEl.appendChild(row);
      probsEl.appendChild(bar);
    });
    if(arr.length){
      const top = arr[0];
      topLabelEl.textContent = `예측 결과: ${top.className} (${(top.probability*100).toFixed(1)}%)`;
    } else topLabelEl.textContent = "";
  }

  async function loadModel(){
    try{
      setStatus("모델 로딩 중…");
      const modelURL = MODEL_URL + "model.json";
      const metadataURL = MODEL_URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      classNames = model.getClassLabels ? model.getClassLabels()
                 : Array.from({length:model.getTotalClasses()}, (_,i)=>`Class ${i}`);
      setStatus(`웹캠을 열거나 파일을 업로드 해주세요.`);
      btnWebcam.disabled = false;
      btnUpload.disabled = false;
    }catch(e){
      console.error(e);
      setStatus("모델 로드 실패.", true);
    }
  }
  window.addEventListener("DOMContentLoaded", loadModel);

  btnWebcam.addEventListener("click", async ()=>{
    if(!model) return setStatus("모델이 준비되지 않았습니다.", true);
    hideAllInputs();
    setStatus("웹캠 준비중...");
    try{
      webcam = new tmImage.Webcam(FRAME_SIZE, FRAME_SIZE, true);
      await webcam.setup();
      await webcam.play();
      webcamEl.classList.remove("hidden");
      canvasEl.classList.remove("hidden");
      canvasEl.width = FRAME_SIZE;
      canvasEl.height = FRAME_SIZE;
      setStatus("웹캠으로 표정을 실시간으로 판단하고 있습니다…");
      smoothQueue = [];
      loopWebcam();
    }catch(e){
      console.error(e);
      setStatus("웹캠 권한이 거부되었거나 HTTPS 환경이 아닐 수 있습니다.", true);
    }
  });

  async function loopWebcam(){
    if(!webcam) return;
    webcam.update();
    const ctx = canvasEl.getContext("2d");
    ctx.drawImage(webcam.canvas, 0, 0, canvasEl.width, canvasEl.height);
    const preds = await model.predict(canvasEl);
    const vec = preds.map(p=>p.probability);

    smoothQueue.push(vec);
    if(smoothQueue.length > SMOOTH_N) smoothQueue.shift();
    const avg = smoothQueue[0].map((_,i)=>smoothQueue.reduce((s,v)=>s+v[i],0)/smoothQueue.length);

    renderProbs(avg);
    rafId = requestAnimationFrame(loopWebcam);
  }

  function stopWebcamLoop(){
    if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
    if(webcam){ webcam.stop(); webcam = null; }
  }

  btnUpload.addEventListener("click", ()=>{
    if(!model) return setStatus("모델이 아직 준비되지 않았습니다.", true);
    hideAllInputs();
    setStatus("파일 업로드 준비중...");
    dropZone.classList.remove("hidden");
    btnReset.classList.add("hidden");
  });

  dropZone.addEventListener("dragover", (e)=>{
    e.preventDefault();
    dropZone.classList.add("dragover");
  });
  dropZone.addEventListener("dragleave", ()=> dropZone.classList.remove("dragover"));
  dropZone.addEventListener("drop", (e)=>{
    e.preventDefault();
    dropZone.classList.remove("dragover");
    const file = e.dataTransfer.files[0];
    if(file) handleImageFile(file);
  });
  dropZone.addEventListener("click", ()=> fileInput.click());
  fileInput.addEventListener("change", (e)=>{
    const file = e.target.files[0];
    if(file) handleImageFile(file);
  });

  async function handleImageFile(file){
    hideAllInputs();
    previewEl.classList.remove("hidden");
    btnReset.classList.remove("hidden");
    const url = URL.createObjectURL(file);
    previewEl.src = url;
    previewEl.onload = async ()=>{
      setStatus("이미지 예측 중…");
      try{
        const preds = await model.predict(previewEl);
        renderProbs(preds.map(p=>p.probability));
        setStatus("인공지능이 사진 판별을 완료하였습니다.");
      }catch(err){
        console.error(err);
        setStatus("예측 중 오류가 발생하였습니다.", true);
      }
    };
  }

  btnReset.addEventListener("click", ()=>{
    hideAllInputs();
    probsEl.innerHTML = "";
    topLabelEl.textContent = "";
    btnReset.classList.add("hidden");
    setStatus("웹캠을 열거나 파일을 업로드 해주세요.");
  });

  window.addEventListener("beforeunload", stopWebcamLoop);
</script>
</body>
</html>
