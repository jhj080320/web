<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>해안거품 판별</title>

  <!-- 라이브러리: 순서 유지! -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body { max-width: 720px; margin: 40px auto; font-family: system-ui, sans-serif; }
    .row { margin: 12px 0; }
    #preview { max-width: 100%; display: none; border: 1px solid #ddd; border-radius: 10px; }
    #result { font-size: 18px; margin-top: 12px; }
    .muted { color:#666; font-size:14px; }
    button, input { padding: 8px 12px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>해안거품 판별</h1>

  <div class="row">
    <input id="fileInput" type="file" accept="image/*">
    <button id="btnPredict" disabled>예측하기</button>
  </div>

  <img id="preview" alt="업로드한 이미지 미리보기" />
  <div id="result" class="row"></div>
  <div class="muted">* 브라우저에서 TF.js + Teachable Machine으로 예측합니다. 서버/파이썬 불필요.</div>

  <script>
    // 로딩 확인(선택)
    console.log("tf:", typeof tf);
    console.log("tmImage:", typeof tmImage);

    // 1) 모델 경로 (절대/상대 아무거나; 지금은 상대경로)
    const MODEL_URL = "./model/";  // 해안거품/index.html 옆의 model 폴더

    // 2) 전역 변수
    let model;
    let classname = [];
    let ready = false;

    // 3) 모델 로드
    async function loadTmModel() {
      try {
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        classname = model.getClassLabels();
        ready = true;
        document.getElementById("btnPredict").disabled = false;
        console.log("모델 로드 완료:", classname);
      } catch (e) {
        console.error("모델 로드 실패:", e);
        document.getElementById("result").textContent = "모델 로드 실패. MODEL_URL/파일 경로를 확인하세요.";
      }
    }
    loadTmModel();

    // 4) 파일 선택 → 미리보기
    const fileInput = document.getElementById("fileInput");
    const preview   = document.getElementById("preview");
    let currentImageEl = null;

    fileInput.addEventListener("change", () => {
      const file = fileInput.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = "block";
      currentImageEl = preview;
      document.getElementById("result").textContent = "";
    });

    // 5) 예측
    document.getElementById("btnPredict").addEventListener("click", async () => {
      const resultEl = document.getElementById("result");
      if (!ready) { resultEl.textContent = "모델이 아직 준비되지 않았습니다."; return; }
      if (!currentImageEl) { resultEl.textContent = "먼저 이미지를 선택하세요."; return; }

      const predictions = await model.predict(currentImageEl);
      const P = predictions.map(p => p.probability);
      let P_index = 0;
      for (let i = 1; i < P.length; i++) if (P[i] > P[P_index]) P_index = i;
      const P_label = predictions[P_index].className;
      const Px      = predictions[P_index].probability;

      resultEl.textContent = `예측 결과: ${P_label} (신뢰도: ${(Px * 100).toFixed(2)}%)`;
      console.log("전체 예측:", predictions);
    });
  </script>
</body>
</html>
