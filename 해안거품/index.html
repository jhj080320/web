<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>해안거품 판별</title>

  <!-- 라이브러리 (순서 중요) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220; --card:#131b2e; --muted:#8aa1c1; --text:#eaf1ff; --accent:#2f73ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --border:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; background:linear-gradient(180deg,#0a1120, #0b132b);
      color:var(--text); font-family: ui-sans-serif,system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:960px; margin:0 auto}
    h1{font-size:28px; margin:0 0 16px; font-weight:800; letter-spacing:.2px}
    p.sub{margin:0 0 24px; color:var(--muted)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:20px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25)}
    .drop{
      border:1.5px dashed var(--border); border-radius:14px; padding:18px; text-align:center; transition:.2s;
      background: rgba(255,255,255,.02);
    }
    .drop.drag{ border-color: var(--accent); background: rgba(47,115,255,.08) }
    .row{margin:12px 0}
    .btn{
      appearance:none; border:none; border-radius:12px; padding:12px 16px; font-weight:700;
      background:var(--accent); color:white; cursor:pointer; transition:.2s; width:100%;
    }
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn.secondary{ background:transparent; border:1px solid var(--border); color:var(--text) }
    .actions{display:flex; gap:12px; margin-top:12px}
    .preview{
      width:100%; aspect-ratio:4/3; object-fit:contain; display:none; border-radius:12px; border:1px solid var(--border); background:#0d1426;
    }

    .result{display:none}
    .badge{display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:var(--muted)}
    .score{font-size:18px; margin-top:8px}
    .bars{margin-top:10px; display:grid; gap:8px}
    .bar{display:flex; align-items:center; gap:8px}
    .bar .label{width:120px; color:var(--muted); font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .bar .track{flex:1; height:10px; background:#0d172a; border-radius:999px; overflow:hidden; border:1px solid var(--border)}
    .bar .fill{height:100%; width:0%; background:var(--accent); transition: width .4s ease}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; margin-left:8px}
    .ok{background:rgba(34,197,94,.15); color:#86efac; border:1px solid rgba(34,197,94,.4)}
    .warn{background:rgba(245,158,11,.15); color:#facc15; border:1px solid rgba(245,158,11,.4)}
    .bad{background:rgba(239,68,68,.15); color:#fca5a5; border:1px solid rgba(239,68,68,.4)}

    .toast{position:fixed; right:16px; bottom:16px; background:#0e1629; border:1px solid var(--border); color:var(--text);
      padding:10px 14px; border-radius:12px; display:none; box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .spinner{width:18px; height:18px; border:3px solid rgba(255,255,255,.25); border-top-color:#fff; border-radius:50%;
      display:inline-block; animation:spin 1s linear infinite; vertical-align:middle; margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>해안거품 판별</h1>
    <p class="sub">이미지 파일을 업로드하면, 브라우저에서 바로 모델로 판별합니다. (서버/파이썬 불필요)</p>

    <div class="grid">
      <!-- 업로드 카드 -->
      <div class="card">
        <div id="drop" class="drop">
          <input id="fileInput" type="file" accept="image/*" style="display:none">
          <p style="margin:0 0 8px">파일을 이 영역에 끌어다 놓거나, 아래 버튼으로 선택하세요.</p>
          <div class="actions">
            <button id="btnBrowse" class="btn secondary" type="button">파일 선택</button>
            <button id="btnPredict" class="btn" type="button" disabled>예측하기</button>
          </div>
        </div>
        <div class="row">
          <img id="preview" class="preview" alt="업로드한 이미지 미리보기" />
        </div>
        <div class="actions">
          <button id="btnReset" class="btn secondary" type="button">초기화</button>
        </div>
      </div>

      <!-- 결과 카드 -->
      <div class="card result" id="resultCard">
        <div><span class="badge">결과</span></div>
        <div class="score" id="mainResult" style="margin-top:8px">-</div>
        <div class="bars" id="bars"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ===== 1) 모델 경로 (해안거품/index.html 옆의 model 폴더) =====
    const MODEL_URL = "./model/"; // 또는 절대경로: "https://jhj080320.github.io/web/해안거품/model/"

    // ===== 2) 상태 =====
    let model, classname = [], ready = false, currentImageEl = null;

    // ===== 3) 유틸 =====
    const $ = sel => document.querySelector(sel);
    function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=> t.style.display="none", 2200); }
    function setBusy(el, busy){
      if(busy){ el.disabled = true; el.dataset.label = el.textContent; el.innerHTML = '<span class="spinner"></span>'+ (el.dataset.loadingText||'처리 중'); }
      else{ el.disabled = false; el.textContent = el.dataset.label || el.textContent; }
    }

    // ===== 4) 모델 로드 =====
    async function loadTmModel() {
      try {
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        classname = model.getClassLabels();
        ready = true;
        $("#btnPredict").disabled = false;
        console.log("모델 로드 완료:", classname);
      } catch (e) {
        console.error("모델 로드 실패:", e);
        toast("모델 로드 실패: 경로/파일 확인");
      }
    }
    loadTmModel();

    // ===== 5) 업로드 & 드래그앤드롭 =====
    const fileInput = $("#fileInput");
    const preview   = $("#preview");
    const drop      = $("#drop");
    $("#btnBrowse").addEventListener("click", ()=> fileInput.click());

    drop.addEventListener("dragover", e => { e.preventDefault(); drop.classList.add("drag"); });
    drop.addEventListener("dragleave", ()=> drop.classList.remove("drag"));
    drop.addEventListener("drop", e => {
      e.preventDefault(); drop.classList.remove("drag");
      const file = e.dataTransfer.files?.[0]; if(!file) return;
      handleFile(file);
    });

    fileInput.addEventListener("change", ()=>{
      const file = fileInput.files?.[0]; if(!file) return;
      handleFile(file);
    });

    function handleFile(file){
      if(!file.type.startsWith("image/")){ toast("이미지 파일을 선택하세요."); return; }
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = "block";
      currentImageEl = preview;
      $("#resultCard").style.display = "none";
      $("#bars").innerHTML = "";
      $("#mainResult").textContent = "-";
    }

    // ===== 6) 예측 =====
    const btnPredict = $("#btnPredict");
    btnPredict.dataset.loadingText = "예측 중";
    btnPredict.addEventListener("click", async ()=>{
      const resultCard = $("#resultCard");
      if(!ready){ toast("모델 준비 중입니다."); return; }
      if(!currentImageEl){ toast("먼저 이미지를 선택하세요."); return; }

      try{
        setBusy(btnPredict, true);
        const predictions = await model.predict(currentImageEl); // [{className, probability}, ...]
        // 정렬해서 Top-3 표시
        predictions.sort((a,b)=> b.probability - a.probability);
        const top3 = predictions.slice(0, Math.min(3, predictions.length));

        const P_label = top3[0].className;
        const Px = top3[0].probability;
        const confPct = (Px*100).toFixed(2) + "%";

        // 메인 결과 문구 + 신뢰도 색상 뱃지
        let pillClass = Px >= 0.8 ? "ok" : Px >= 0.5 ? "warn" : "bad";
        $("#mainResult").innerHTML = `예측 결과: <b>${P_label}</b> <span class="pill ${pillClass}">${confPct}</span>`;

        // 막대 그래프
        const bars = $("#bars");
        bars.innerHTML = "";
        top3.forEach(p=>{
          const row = document.createElement("div");
          row.className = "bar";
          row.innerHTML = `
            <div class="label" title="${p.className}">${p.className}</div>
            <div class="track"><div class="fill" style="width:${(p.probability*100).toFixed(1)}%"></div></div>
            <div style="width:60px; text-align:right">${(p.probability*100).toFixed(1)}%</div>
          `;
          bars.appendChild(row);
        });

        resultCard.style.display = "block";
      }catch(err){
        console.error(err);
        toast("예측 중 오류가 발생했습니다.");
      }finally{
        setBusy(btnPredict, false);
      }
    });

    // ===== 7) 초기화 =====
    $("#btnReset").addEventListener("click", ()=>{
      fileInput.value = "";
      preview.src = "";
      preview.style.display = "none";
      currentImageEl = null;
      $("#resultCard").style.display = "none";
      $("#bars").innerHTML = "";
      $("#mainResult").textContent = "-";
    });
  </script>
</body>
</html>
